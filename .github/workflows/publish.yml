name: Nightly
 
on:
    push:
        branches:
            - 'master'
            - 'actions'
        tags-ignore:
            - '**'
    pull_request:
        paths-ignore:
            - 'docs/*'
            - '*.yml'
            - '*.md'
            - 'LICENSE'

    schedule:
        - cron: '46 20 * * *'

    workflow_dispatch:
        inputs:
            custom_date:
                description: 'Custom date (YYYY-MM-DD format, leave empty for today)'
                required: false
                type: string

concurrency: 
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    Prepare:
        runs-on: ubuntu-latest
        outputs:
            date: ${{ steps.metadata.outputs.date }}
            date_hyphenated: ${{ steps.metadata.outputs.date_hyphenated }}
            git_sha: ${{ steps.metadata.outputs.git_sha }}
            version: ${{ steps.metadata.outputs.version }}
        steps:
            - uses: actions/checkout@v4
            
            - name: Prepare metadata
              id: metadata
              run: |
                # Use custom date if provided, otherwise use today
                if [ -n "${{ inputs.custom_date }}" ]; then
                  DATE_HYPHENATED="${{ inputs.custom_date }}"
                  DATE=$(echo "$DATE_HYPHENATED" | tr -d '-')
                else
                  DATE=$(date -u '+%Y%m%d')
                  DATE_HYPHENATED=$(date -u '+%Y-%m-%d')
                fi
                
                echo "date=$DATE" >> $GITHUB_OUTPUT
                echo "date_hyphenated=$DATE_HYPHENATED" >> $GITHUB_OUTPUT
                
                # Get the latest commit SHA from arturo-lang/arturo repo
                ARTURO_SHA=$(gh api repos/arturo-lang/arturo/commits/master --jq '.sha[0:7]')
                echo "git_sha=$ARTURO_SHA" >> $GITHUB_OUTPUT
                
                echo "version=nightly.$DATE" >> $GITHUB_OUTPUT
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    Build:
        needs: Prepare
        runs-on: ${{ 
            (matrix.os == 'linux')   && (matrix.support == 'legacy' && (matrix.arch == 'arm64' && 'ubuntu-22.04-arm' || 'ubuntu-22.04') || matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest') ||
            (matrix.os == 'macos')   && (matrix.arch == 'arm64' && 'macos-latest' || 'macOS-15-intel') ||
            (matrix.os == 'windows') && 'windows-latest' || 
                                        'ubuntu-latest'  }}
                                                                   
        strategy:
            matrix:
                include: 
                    - {os: linux,   arch: amd64}
                    - {os: linux,   arch: amd64,    support: legacy}
                    - {os: linux,   arch: amd64,    mode: mini}
                    - {os: linux,   arch: arm64}
                    - {os: linux,   arch: arm64,    support: legacy}
                    - {os: linux,   arch: arm64,    mode: mini}
                    - {os: freebsd, arch: amd64}
                    - {os: freebsd, arch: amd64,    mode: mini}
                    - {os: macos,   arch: amd64}
                    - {os: macos,   arch: amd64,    mode: mini}
                    - {os: macos,   arch: arm64}
                    - {os: macos,   arch: arm64,    mode: mini}
                    - {os: windows, arch: amd64}
                    - {os: windows, arch: amd64,    mode: mini}
                    - {os: web,     arch: js,       mode: mini}
 
        defaults:
            run:
                shell: ${{ 
                    (matrix.os == 'freebsd') && 'freebsd {0}' ||
                    (matrix.os == 'windows') && 'msys2 {0}'   || 
                                                'bash'        }}

        steps:
            - name: Install Arturo
              uses: arturo-lang/setup-arturo@v2
              with: 
                do: compile
                token: ${{ secrets.GITHUB_TOKEN }}
                os: ${{ matrix.os }}
                arch: ${{ matrix.arch }}
                mode: ${{ matrix.mode }}
                support: ${{ matrix.support }}
                metadata: ${{ needs.Prepare.outputs.version }}
                create_artifact: 'true'
                artifact_version: ${{ needs.Prepare.outputs.version }}

    Release:
        runs-on: ubuntu-latest
        if: (github.event_name == 'schedule') || (github.event_name == 'workflow_dispatch')
        needs: 
            - Prepare
            - Build
        steps:
            - uses: actions/checkout@v4
            
            - name: Download artifacts
              uses: dawidd6/action-download-artifact@v11
              with:
                github_token: ${{ secrets.GITHUB_TOKEN }}
                run_id: ${{ github.run_id }}
                path: ./assets
                skip_unpack: true

            - name: Create source archive
              run: |
                VERSION=${{ needs.Prepare.outputs.version }}
                git clone --depth 1 https://github.com/arturo-lang/arturo.git arturo-source
                cd arturo-source
                git archive --format=zip --prefix=arturo-$VERSION/ HEAD > ../assets/arturo-$VERSION-src.zip
                git archive --format=tar.gz --prefix=arturo-$VERSION/ HEAD > ../assets/arturo-$VERSION-src.tar.gz
  
            - name: Debug environment
              run: |
                ls -laR ./assets

            - name: Upload release assets
              run: |
                BODY="**Commit:** [\`${{ needs.Prepare.outputs.git_sha }}\`](https://github.com/arturo-lang/arturo/commit/${{ needs.Prepare.outputs.git_sha }})"

                gh release delete "${{ needs.Prepare.outputs.date_hyphenated }}" --yes --cleanup-tag 2>/dev/null || true
                
                gh release create "${{ needs.Prepare.outputs.date_hyphenated }}" \
                  --title "${{ needs.Prepare.outputs.date_hyphenated }}" \
                  --notes "$BODY" \
                  ./assets/*
              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    Deploy:
        uses: arturo-lang/website/.github/workflows/deploy.yml@main
        needs: Release
        if: (github.event_name == 'schedule') || (github.event_name == 'workflow_dispatch')
        secrets: inherit
        with:
            channel: 'latest'
